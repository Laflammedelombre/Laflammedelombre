<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script>
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-PMTZHZKR');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Flamme de l'Ombre - Suivi de Demande</title>
    <style>
        /* Styles CSS */
        body { background-color: black; color: white; font-family: Arial, sans-serif; margin: 0; padding: 0; text-align: center; }
        header { padding: 20px; }
        h1 { font-size: 3em; margin: 0.2em 0; }
        p { font-size: 1.5em; margin-top: 10px; }
        nav ul { list-style-type: none; padding: 0; margin: 20px 0; display: flex; flex-wrap: wrap; justify-content: center; }
        nav ul li { margin: 10px 15px; }
        nav ul li a { color: white; text-decoration: none; font-weight: bold; padding: 5px 10px; border-radius: 4px; }
        nav ul li a:hover { text-decoration: underline; }

        .content-container { max-width: 800px; margin: 40px auto; background: #111; padding: 30px; border-radius: 10px; text-align: left; }
        .content-container h2 { text-align: center; color: #fff; margin-bottom: 25px; }
        
        .search-form { display: flex; gap: 10px; margin-bottom: 30px; align-items: center; }
        .search-form input[type="text"] { flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid #555; background: #222; color: #fff; }
        .search-form button { padding: 10px 15px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        .search-form button:hover { background: #0056b3; }

        #result-container { padding: 15px; border-radius: 6px; margin-top: 20px; text-align: center; }
        .status-message { margin-top: 12px; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold; }
        .status-info { background: #333; padding: 15px; border-radius: 8px; margin-top: 20px; line-height: 1.6; }
        
        .status-demande-recue, .status-en-cours { background-color: #3c5244; border: 1px solid #7ad6a7; color: #d4edda; }
        .status-traitee { background-color: #2a3e5c; border: 1px solid #5c7fbf; color: #c9e6ff; }
        .status-annulee, .status-id-inconnu { background-color: #5c3434; border: 1px solid #f1a0a0; color: #f8d7da; }

        #cancel-button {
            margin-top: 15px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #cc0000;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        #cancel-button:hover { background: #ff3333; }

        #waiting-list-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #333; }
        #waiting-list-section h3 { text-align: center; margin-bottom: 15px; color: #aaa; }
        #waiting-list { list-style-type: none; padding: 0; max-height: 250px; overflow-y: auto; background: #222; border-radius: 6px; }
        #waiting-list li { padding: 8px 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; font-size: 0.9em; }
        #waiting-list li:last-child { border-bottom: none; }
        .list-id { color: #888; font-family: monospace; }
        .list-status { font-weight: bold; color: #7ad6a7; }

        @media (max-width: 768px) { .content-container { margin: 20px; padding: 20px; } h1 { font-size: 2.5em; } p { font-size: 1.2em; } }
        @media (max-width: 480px) { h1 { font-size: 2em; } p { font-size: 1em; } nav ul li { margin: 10px 5px; } .search-form { flex-direction: column; } .search-form button, .search-form input { width: 100%; } }
    </style>
</head>
<body>
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMTZHZKR"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header>
    <h1>La Flamme de l'Ombre</h1>
    <p>Suivi de ta Demande</p>
</header>

<nav>
    <ul>
        <li><a href="index.html">Accueil</a></li>
        <li><a href="about.html">√Ä propos</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="avis.html">Avis</a></li>
        <li><a href="carte.html">Carte du jour</a></li>
    </ul>
</nav>

<div class="content-container">
    <h2>V√©rifier le Statut</h2>
    
    <form id="searchForm" class="search-form">
        <input type="text" id="trackingId" placeholder="Entrez votre ID de suivi (ex: 1700000000000)" required>
        <button type="submit">Rechercher</button>
    </form>

    <div id="result-container" style="display: none;">
        <div id="statusMessage" class="status-message"></div>
        <div id="statusInfo" class="status-info"></div>
        <button id="cancel-button" style="display: none;">Annuler ma demande</button>
    </div>

    <div id="waiting-list-section">
        <h3>Queue des 10 prochaines demandes</h3>
        <ul id="waiting-list">
            <li>Chargement...</li>
        </ul>
    </div>
</div>

<script>
    // üõë ATTENTION : CETTE URL DOIT CORRESPONDRE √Ä VOTRE DERNIER D√âPLOIEMENT APPS SCRIPT
    // Utilisez l'URL que vous avez g√©n√©r√©e et valid√©e :
    const APPS_SCRIPT_URL_SEARCH = 'https://script.google.com/macros/s/AKfycbx69mO2qRsvT4lHwBeBoA6DF7l0HGcdSVQkDLVe72hz9aNkLmuL5q-q5B2RYLYdv2kG0w/exec'; 

    const searchForm = document.getElementById('searchForm');
    const trackingIdInput = document.getElementById('trackingId');
    const resultContainer = document.getElementById('result-container');
    const statusMessageDiv = document.getElementById('statusMessage');
    const statusInfoDiv = document.getElementById('statusInfo');
    const cancelButton = document.getElementById('cancel-button');
    const waitingListUl = document.getElementById('waiting-list');
    
    // √âtat local de la demande recherch√©e
    let currentTrackingId = null;

    // Fonction utilitaire pour le statut
    function getStatusClass(status) {
        if (!status) return 'status-id-inconnu';
        const upperStatus = status.toUpperCase().trim();
        if (upperStatus.includes('RE√áUE') || upperStatus.includes('RE√áU')) return 'status-demande-recue';
        if (upperStatus.includes('EN COURS')) return 'status-demande-recue status-en-cours';
        if (upperStatus.includes('TRAIT√âE') || upperStatus.includes('TRAIT√â')) return 'status-traitee';
        if (upperStatus.includes('ANNUL√âE') || upperStatus.includes('ANNUL√â')) return 'status-annulee';
        return 'status-id-inconnu';
    }

    // Affichage des informations
    function displayStatus(data) {
        resultContainer.style.display = 'block';
        currentTrackingId = trackingIdInput.value.trim();

        // Ajoute la classe de couleur au message
        statusMessageDiv.className = 'status-message ' + getStatusClass(data.status);
        
        let infoHtml = `
            <strong>ID de Suivi :</strong> ${currentTrackingId}<br>
            <strong>Statut :</strong> ${data.status || 'Non trouv√©'}
        `;

        if (data.message) {
            infoHtml += `<p>${data.message}</p>`;
        }
        
        statusInfoDiv.innerHTML = infoHtml;
        
        // G√©rer le bouton d'annulation
        const upperStatus = data.status.toUpperCase().trim();
        if (upperStatus.includes('RE√áUE') || upperStatus.includes('RE√áU') || upperStatus.includes('EN COURS')) {
            cancelButton.style.display = 'block';
        } else {
            cancelButton.style.display = 'none';
        }

        // Afficher la liste d'attente mise √† jour
        displayWaitingList(data.top10Requests);
    }
    
    // Affichage de la liste d'attente
    function displayWaitingList(requests) {
        waitingListUl.innerHTML = ''; // Nettoyer
        if (!requests || requests.length === 0) {
            waitingListUl.innerHTML = '<li>Aucune demande en attente ou erreur de chargement.</li>';
            return;
        }

        requests.forEach((req, index) => {
            const statusClass = getStatusClass(req.status);
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <span>N¬∞${index + 1} - <span class="list-id">${req.id}</span></span>
                <span class="list-status ${statusClass}">${req.status}</span>
            `;
            waitingListUl.appendChild(listItem);
        });
    }

    // Fonction principale de recherche
    function checkStatus(id = null) {
        const idToCheck = id || trackingIdInput.value.trim();
        if (!idToCheck) return;

        statusMessageDiv.innerHTML = '<div class="status-message sending">‚öôÔ∏è Recherche en cours...</div>';
        resultContainer.style.display = 'block';
        cancelButton.style.display = 'none';

        fetch(`${APPS_SCRIPT_URL_SEARCH}?action=getstatus&id=${idToCheck}`)
        .then(response => {
            if (!response.ok) throw new Error('Erreur r√©seau ou script non autoris√©.');
            return response.json();
        })
        .then(data => {
            if (data.result === 'error') {
                statusMessageDiv.innerHTML = `<div class="status-message status-annulee">‚ùå ${data.message}</div>`;
                statusInfoDiv.innerHTML = '';
            } else {
                displayStatus(data);
            }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            statusMessageDiv.innerHTML = '<div class="status-message status-annulee">‚ùå Erreur de connexion au serveur de suivi.</div>';
            statusInfoDiv.innerHTML = '';
        });
    }

    // Gestion de la soumission du formulaire de recherche
    searchForm.addEventListener('submit', function(event) {
        event.preventDefault();
        checkStatus();
    });

    // Fonction d'annulation
    cancelButton.addEventListener('click', function() {
        if (!currentTrackingId || !confirm('√ätes-vous s√ªr(e) de vouloir annuler la demande ' + currentTrackingId + ' ? Cette action est irr√©versible.')) {
            return;
        }

        cancelButton.disabled = true;
        cancelButton.textContent = 'Annulation...';

        fetch(`${APPS_SCRIPT_URL_SEARCH}?action=cancelrequest&id=${currentTrackingId}`)
        .then(response => {
            if (!response.ok) throw new Error('Erreur r√©seau.');
            return response.json();
        })
        .then(data => {
            
            // üõë GESTION DU STATUT 'EN COURS' (Point 3)
            if (data.result === 'error_in_progress') {
                alert("üö® ATTENTION : Votre demande est EN COURS de traitement et ne peut plus √™tre annul√©e. Merci de contacter le support si n√©cessaire.");
            } else if (data.result === 'success') {
                alert('‚úÖ Annulation r√©ussie : ' + data.message);
            } else {
                alert('‚ùå Erreur d\'annulation : ' + data.message);
            }
            
            checkStatus(currentTrackingId); // Recharge le statut pour mettre √† jour l'affichage
        })
        .catch(error => {
            console.error('Erreur lors de l\'annulation:', error);
            alert('‚ùå Erreur de r√©seau lors de la tentative d\'annulation.');
        })
        .finally(() => {
            cancelButton.disabled = false;
            cancelButton.textContent = 'Annuler ma demande';
        });
    });

    // Chargement initial (pour afficher la liste des 10 premi√®res demandes)
    document.addEventListener('DOMContentLoaded', () => {
        fetch(`${APPS_SCRIPT_URL_SEARCH}?action=gettop10`)
        .then(response => response.json())
        .then(data => {
            displayWaitingList(data.top10Requests);
        })
        .catch(error => {
            console.error('Erreur lors du chargement initial de la liste:', error);
            waitingListUl.innerHTML = '<li>Impossible de charger la liste d\'attente.</li>';
        });
    });
</script>

</body>
</html>
